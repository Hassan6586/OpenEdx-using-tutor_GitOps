---
# Helm Values for OpenEdX on AWS EKS
# This file can be used with the Tutor Helm chart for advanced customization
# Reference: https://docs.tutor.overhauled.education/v12.1.0/

# Global settings
global:
  namespace: openedx
  environment: production
  domain: openedx.example.com
  
  # Container image settings
  imageRegistry: docker.io
  imagePullPolicy: IfNotPresent
  
  # Database configuration
  database:
    mysql:
      # Will use external RDS endpoint from Terraform outputs
      enabled: false  # Using external RDS
      host: ""
      port: 3306
      username: openedx_user
      database: openedx_prod
      # Password from Kubernetes Secret
      passwordSecretName: openedx-db-credentials
      passwordSecretKey: mysql_password
    
    mongodb:
      enabled: false  # Using external DocumentDB
      host: ""
      port: 27017
      username: openedx_user
      database: openedx_prod
      passwordSecretName: openedx-db-credentials
      passwordSecretKey: mongodb_password
    
    redis:
      enabled: false  # Using external ElastiCache
      host: ""
      port: 6379
      passwordSecretName: openedx-db-credentials
      passwordSecretKey: redis_auth_token
  
  # S3 Storage configuration
  s3:
    enabled: true
    bucket: openedx-media
    region: us-east-1
    access_key_id_secret: openedx-s3-credentials
    secret_access_key_secret: openedx-s3-credentials

# LMS Configuration
lms:
  replicaCount: 3
  
  image:
    repository: docker.io/openedx/lms
    tag: latest
    pullPolicy: IfNotPresent
  
  service:
    type: ClusterIP
    port: 8000
    targetPort: 8000
  
  ingress:
    enabled: true
    className: nginx
    annotations:
      cert-manager.io/cluster-issuer: letsencrypt-prod
      nginx.ingress.kubernetes.io/ssl-redirect: "true"
      nginx.ingress.kubernetes.io/proxy-body-size: "100m"
      nginx.ingress.kubernetes.io/limit-rps: "100"
      nginx.ingress.kubernetes.io/rate-limit: "100"
      nginx.ingress.kubernetes.io/enable-modsecurity: "true"
      nginx.ingress.kubernetes.io/enable-owasp-core-rules: "true"
    hosts:
      - host: openedx.example.com
        paths:
          - path: /
            pathType: Prefix
    tls:
      - secretName: openedx-tls
        hosts:
          - openedx.example.com
  
  resources:
    requests:
      cpu: 500m
      memory: 512Mi
    limits:
      cpu: 1000m
      memory: 1Gi
  
  autoscaling:
    enabled: true
    minReplicas: 3
    maxReplicas: 10
    targetCPUUtilizationPercentage: 70
    targetMemoryUtilizationPercentage: 80
  
  livenessProbe:
    httpGet:
      path: /health/live
      port: 8000
    initialDelaySeconds: 30
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 3
  
  readinessProbe:
    httpGet:
      path: /health/ready
      port: 8000
    initialDelaySeconds: 10
    periodSeconds: 5
    timeoutSeconds: 3
    failureThreshold: 2
  
  environment:
    DEBUG: "false"
    LOG_LEVEL: "INFO"
    DJANGO_SETTINGS_MODULE: "lms.envs.tutor.aws"
    SERVICE_VARIANT: "lms"
    CELERY_BROKER_TRANSPORT: "redis"
    CELERY_RESULT_BACKEND: "redis"
  
  persistence:
    staticFiles:
      enabled: true
      storageClass: efs-sc
      size: 50Gi
      mountPath: /openedx/staticfiles
    
    media:
      enabled: true
      storageClass: efs-sc
      size: 100Gi
      mountPath: /openedx/media
    
    logs:
      enabled: true
      emptyDir: true
      mountPath: /openedx/logs

# CMS Configuration
cms:
  replicaCount: 2
  
  image:
    repository: docker.io/openedx/cms
    tag: latest
    pullPolicy: IfNotPresent
  
  service:
    type: ClusterIP
    port: 8010
    targetPort: 8010
  
  ingress:
    enabled: true
    className: nginx
    annotations:
      cert-manager.io/cluster-issuer: letsencrypt-prod
      nginx.ingress.kubernetes.io/ssl-redirect: "true"
      nginx.ingress.kubernetes.io/auth-type: basic
      nginx.ingress.kubernetes.io/auth-secret: cms-basic-auth
      nginx.ingress.kubernetes.io/auth-realm: "CMS Access"
    hosts:
      - host: cms.openedx.example.com
        paths:
          - path: /
            pathType: Prefix
    tls:
      - secretName: cms-tls
        hosts:
          - cms.openedx.example.com
  
  resources:
    requests:
      cpu: 400m
      memory: 256Mi
    limits:
      cpu: 800m
      memory: 512Mi
  
  autoscaling:
    enabled: true
    minReplicas: 2
    maxReplicas: 5
    targetCPUUtilizationPercentage: 75
    targetMemoryUtilizationPercentage: 80
  
  livenessProbe:
    httpGet:
      path: /health/live
      port: 8010
    initialDelaySeconds: 30
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 3
  
  readinessProbe:
    httpGet:
      path: /health/ready
      port: 8010
    initialDelaySeconds: 10
    periodSeconds: 5
    timeoutSeconds: 3
    failureThreshold: 2
  
  environment:
    DEBUG: "false"
    LOG_LEVEL: "INFO"
    SERVICE_VARIANT: "cms"
  
  persistence:
    staticFiles:
      enabled: true
      storageClass: efs-sc
      size: 50Gi
      mountPath: /openedx/staticfiles
    
    media:
      enabled: true
      storageClass: efs-sc
      size: 100Gi
      mountPath: /openedx/media

# Worker Configuration
worker:
  replicaCount: 3
  
  image:
    repository: docker.io/openedx/worker
    tag: latest
    pullPolicy: IfNotPresent
  
  resources:
    requests:
      cpu: 200m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi
  
  autoscaling:
    enabled: true
    minReplicas: 3
    maxReplicas: 10
    targetCPUUtilizationPercentage: 80
    targetMemoryUtilizationPercentage: 80
  
  environment:
    DEBUG: "false"
    LOG_LEVEL: "INFO"
    CELERY_BROKER: "redis"
    CELERY_RESULT_BACKEND: "redis"
    CELERY_WORKER_CONCURRENCY: "4"

# Security Settings
security:
  rbac:
    enabled: true
  
  securityContext:
    runAsNonRoot: true
    runAsUser: 1000
    fsGroup: 1000
    capabilities:
      drop:
        - ALL
  
  podSecurityPolicy:
    enabled: true
  
  networkPolicy:
    enabled: true
    ingress:
      from:
        - namespaceSelector:
            matchLabels:
              name: ingress-nginx
    egress:
      - to:
          - namespaceSelector: {}
        ports:
          - protocol: TCP
            port: 3306  # MySQL
          - protocol: TCP
            port: 27017  # MongoDB
          - protocol: TCP
            port: 6379  # Redis
          - protocol: TCP
            port: 9200  # OpenSearch
          - protocol: TCP
            port: 443   # HTTPS
          - protocol: UDP
            port: 53    # DNS

# Monitoring Configuration
monitoring:
  enabled: true
  
  prometheus:
    enabled: true
    retention: 15d
    scrapeInterval: 30s
    evaluationInterval: 30s
  
  grafana:
    enabled: true
    adminPassword: ""  # Will be generated
    persistence:
      enabled: true
      size: 10Gi
  
  serviceMonitor:
    enabled: true
    interval: 30s
    labels:
      release: prometheus

# Logging Configuration
logging:
  enabled: true
  
  fluentd:
    enabled: true
    image: fluent/fluentd-kubernetes-daemonset:v1-debian-opensearch
    
    outputs:
      - type: opensearch
        host: ""  # Will be set from Terraform output
        port: 9200
        logstashFormat: true
        logstashPrefix: "openedx"
        includeTagKey: true
        tagKey: "_fluentd_tag"
  
  elasticsearch:
    enabled: false  # Using OpenSearch instead
  
  loki:
    enabled: false

# Network Configuration
network:
  # VPC and networking
  vpc:
    cidr: "10.0.0.0/16"
  
  # Network policies
  networkPolicies:
    enabled: true
  
  # Ingress settings
  ingress:
    className: nginx
    defaultCertificateSecret: openedx-tls

# Storage Configuration
storage:
  # Use EFS for persistent storage
  efsStorageClass:
    name: efs-sc
    provisioner: efs.aws.com
    parameters:
      directoryPerms: "700"
  
  # S3 configuration for static assets
  s3:
    staticBucket: openedx-static
    mediaBucket: openedx-media
    backupBucket: openedx-backups
    region: us-east-1
    useAWSCredentials: true

# SMTP Configuration for Email
email:
  enabled: true
  host: ""  # Configure based on your email service
  port: 587
  username: ""
  password: ""  # Use secret
  useTLS: true
  fromAddress: "noreply@openedx.example.com"
  fromName: "OpenEdX"

# Authentication Configuration
authentication:
  # Enable different auth backends
  backends:
    - django.contrib.auth.backends.ModelBackend
    - social_core.backends.google.GoogleOAuth2
    - social_core.backends.microsoft.MicrosoftOAuth2
  
  passwordValidation:
    minLength: 8
    requireUppercase: true
    requireNumbers: true
    requireSpecialChars: true
  
  session:
    cookieSecure: true
    cookieHttpOnly: true
    cookieSameSite: Lax
    timeout: 86400

# Performance Configuration
performance:
  # Caching
  cache:
    backend: redis
    ttl: 3600
  
  # Database pooling
  database:
    poolSize: 30
    maxOverflow: 50
  
  # Celery configuration
  celery:
    brokerTransport: redis
    resultBackend: redis
    workerConcurrency: 4
    workerMaxTasksPerChild: 1000
    taskTimeLimit: 3600
    taskSoftTimeLimit: 3300
  
  # HTTP optimization
  http:
    gzipCompression: true
    http2Enabled: true
    keepaliveTimeout: 65

# Backup Configuration
backup:
  enabled: true
  
  schedule: "0 2 * * *"  # 2 AM daily
  
  database:
    mysql:
      enabled: true
      retentionDays: 30
    
    mongodb:
      enabled: true
      retentionDays: 30
  
  storage:
    s3:
      enabled: true
      bucket: openedx-backups
      prefix: backups/
      encryption: AES256

# Feature Flags
features:
  # Course creation and enrollment
  courseCreation: true
  courseEnrollment: true
  courseDiscovery: true
  
  # Assessment and grading
  proctoring: true
  contentLibraries: true
  
  # Social features
  discussions: true
  learnerSupport: true
  
  # Advanced features
  advancedSecurity: true
  analyticsV2: true
  microlearning: true

# Resource Limits and Quotas
resourceQuotas:
  enabled: true
  
  compute:
    requests:
      cpu: "50"
      memory: "200Gi"
    limits:
      cpu: "100"
      memory: "400Gi"
  
  storage:
    requests: "500Gi"

# Node Affinity and Tolerations
nodeAffinity:
  enabled: true
  preferNodeType: "compute-optimized"

tolerations: []

nodeSelector: {}

# Rollout Strategy
rolloutStrategy:
  type: RollingUpdate
  maxUnavailable: 1
  maxSurge: 1

# Pod Disruption Budget
podDisruptionBudget:
  enabled: true
  minAvailable: 1

# Backup and Restore
backup:
  enabled: true
  schedule: "0 2 * * *"  # 2 AM daily UTC
  retention: 30  # days
  
  includeDatabase: true
  includeStaticFiles: true
  includeMediaFiles: true
  includeConfigurations: true

# ArgoCD Integration
argocd:
  enabled: true
  
  appOfApps: true
  
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
      - PrunePropagationPolicy=background
